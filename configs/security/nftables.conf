#!/usr/sbin/nft -f
# nftables firewall configuration
# Restrictive default policy per Arch Wiki Security recommendations
# /etc/nftables.conf

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority filter; policy drop;

        # Accept established/related connections
        ct state established,related accept

        # Accept loopback
        iif "lo" accept

        # Accept ICMP (ping, etc.) - rate limited
        ip protocol icmp icmp type { echo-request, destination-unreachable, time-exceeded } limit rate 4/second accept
        ip6 nexthdr icmpv6 icmpv6 type { echo-request, destination-unreachable, packet-too-big, time-exceeded, parameter-problem, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert } limit rate 4/second accept

        # Accept DHCPv6 client
        ip6 daddr fe80::/10 udp dport dhcpv6-client accept

        # Drop invalid packets
        ct state invalid drop

        # Log and reject everything else
        limit rate 3/minute log prefix "nftables-dropped: " level info
        reject with icmpx type port-unreachable
    }

    chain forward {
        type filter hook forward priority filter; policy drop;
        # No forwarding by default
    }

    chain output {
        type filter hook output priority filter; policy accept;
        # Allow all outbound traffic
    }
}
